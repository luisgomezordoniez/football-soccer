# Data

This project uses publicly available match-level data provided by Football-Data.co.uk, a long-standing repository of standardized football results and match statistics. The platform compiles official match information from multiple reputable sources—including XScores, BBC Sport, Flashscore, and ESPN—and distributes them in a consistent, computer-ready CSV format suitable for statistical analysis.

## Description


For the purposes of this study, only data from English football competitions were used. These include the Premier League, Championship, League One, League Two, and, when available, the National League. The dataset covers more than two decades of competitive play, with full-time and half-time results available back to the 1993/94 season and detailed match statistics widely available from the 2000/01 season onward.

The variables utilized in this project relate exclusively to match outcomes and in-game performance metrics. These include goals scored, half-time results, shots, shots on target, corners, fouls, offsides, disciplinary actions, and referee information. Historical bookmaker odds—also included in the original files—were intentionally excluded, as the analysis focuses on sporting performance rather than betting markets.

Football-Data.co.uk aggregates information from multiple official and media-based match reporting services to ensure accuracy and completeness. Data are updated on a rolling basis throughout each season and are archived annually, enabling consistent longitudinal analysis across leagues and time periods.

This dataset provides a comprehensive, standardized foundation for evaluating long-term trends in English football, comparing performance across divisions, and studying changes in the nature of the game over time.


## Data Collection

We automated the collection and cleaning of match-level data from the Football-Data.co.uk archive. Using tools from the purrr package, it downloads each available season across the four major English divisions, standardizes column naming conventions across years, removes unused or unavailable variables, and consolidates all leagues into a single harmonized dataset. This approach ensures reproducibility, minimizes manual intervention, and guarantees consistency across more than two decades of historical football data.

```{r}
library(dplyr)
library(tidyr)
library(readr)
library(dplyr)
library(forcats)
library(ggplot2)
library(redav)

not_all_na <- function(x) any(!is.na(x))
year_end = 2025

season_map <- function(start = 1993, end = year_end) {
  season_year_s <- start:(end - 1)
  season_year_e <- (start + 1):end
  
  tibble(
    id_season = sprintf("%02d%02d", season_year_s %% 100, season_year_e %% 100),
    season_name = paste0(season_year_s, "/", season_year_e)
  )
}

query <- function(league, start = 1993, end = year_end) {
  
  temporadas <- season_map(start, end)
  
  keep_cols <- c(
    "Div", "Date", "Time", "HomeTeam", "AwayTeam", "Home", "Away",
    "FTHG", "FTAG", "FTR", "HTHG", "HTAG", "HTR", "Referee",
    "HS", "AS", "HST", "AST", "HF", "AF", "HC", "AC",
    "HY", "AY", "HR", "AR"
  )
  
  dfs <- map2(
    temporadas$id_season,
    temporadas$season_name,
    function(id, season) {
      
      url <- paste0("https://www.football-data.co.uk/mmz4281/", id, "/", league, ".csv")
      
      tryCatch({
        
        df <- read_csv(url, show_col_types = FALSE)
        
        df <- df %>% 
          select(any_of(keep_cols)) %>% 
          select_if(not_all_na)
        
        # fix old Home/Away formats
        if ("Home" %in% names(df)) {
          df <- df %>% rename(HomeTeam = Home, AwayTeam = Away)
        }
        
        df <- df %>%
          mutate(Season = season) %>%
          mutate(across(everything(), as.character))
        
        message("Loaded season: ", season)
        df
        
      }, error = function(e) {
        message("No data for: ", season)
        return(NULL)
      })
    }
  )
  
  # bind all non-null elements
  final <- bind_rows(dfs)
  final=final |> filter(is.na(Div)==F)
  message("Seasons loaded: ", length(unique(final$Season)))
  message("Divisions found: ", paste(unique(final$Div), collapse = ", "))
  
  final
}

#We save a local copy to avoid unnecesary consults to the repository
#E0 <- query("E0")   # Premier League | Tier 1
#E1 <- query("E1")   # Championship | Tier 2
#E2 <- query("E2")   # League One | Tier 3
#E3 <- query("E3")   # League Two | Tier 4

#Data_England=bind_rows(E0,E1,E2,E3)

Data_England <- read_csv("https://github.com/luisgomezordoniez/football-soccer/raw/refs/heads/main/data/Data_England.csv")

Data_England =Data_England |>
  mutate(
    League=case_when(
    Div=="E0" ~"Premier League",
    Div=="E1" ~"Championship",
    Div=="E2" ~"League One",
    Div=="E3" ~"League Two"))



Data_England$League <- factor(Data_England$League, levels =c("Premier League", "Championship","League One", "League Two"), ordered = TRUE)

My_Data_England=Data_England |>
  group_by(Div, Season) |>
  summarise(count=n())

```

## Mising Values 


We can identify three distinct tiers of data completeness across the four tiers of English football. The pre-2000 era is limited to basic match outcomes and full-time goals. From 2000 onwards, the dataset expands to include granular match statistics, such as shots, corners, fouls, and disciplinary records. Finally, post-2020, data fidelity improves further to include match start times.

```{r fig.height= 9, fig.width=8}


library(dplyr)
library(tidyr)
library(ggplot2)
library(tidyr)
library(ggalluvial)
library(lubridate)
library(GGally)
library(scales)   # para rescale()
library(vcd)

missing_summary <- Data_England %>%
  group_by(League, Season) %>%
  summarise(across(everything(), ~100* mean(is.na(.))), .groups = "drop") %>%  # proportion missing
  pivot_longer(
    cols = -c(League, Season),
    names_to = "variable",
    values_to = "prop_missing"
  ) %>%
  group_by(variable) %>%
  mutate(total_missing = mean(prop_missing, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(variable = fct_reorder(variable, total_missing, .desc = TRUE))

missing_summary=missing_summary |>
  mutate(Season=substr(Season, 6,10))

ggplot(missing_summary, aes(x = variable, y = Season, fill = prop_missing)) +
  geom_tile(color = "white") +
  facet_wrap(~ League, scales = "free_y") +
  scale_fill_gradient(
    low = "white",
    high = "#191970",
    name = "Missing (%)"
  ) +
  labs(
    title = "Proportion of Missing Values Across Seasons and Columns by League",
    x = "Variable",
    y = "Season"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    panel.spacing = unit(1, "lines")
  )



```



## Outliers

The heatmap compares how often different outlier-detection methods flag extreme values in each match variable. Across most variables, all three methods identify very few outliers, indicating generally well‑behaved distributions. In contrast, red‑card variables (HR, AR) and, to a lesser extent, full‑time home goals (FTHG) show much higher outlier percentages, especially under the IQR method, revealing heavy tails or rare extreme events, which is reasonable since its not common to have a game with a lot of goals or red cards.

```{r}
outlier_analysis <- function(df, cols) {
  results <- list()
  
  for (col in cols) {
    if (!col %in% names(df)) {
      message(paste("Column", col, "not found. Skipping."))
      next
    }
    
    x <- df[[col]]
    x <- x[!is.na(x)]  # remove NAs
    
    # Summary stats
    stats <- summary(x)
    
    # ---- Z-score method ----
    zscores <- (x - mean(x)) / sd(x)
    z_outliers <- x[abs(zscores) > 3]
    
    # ---- IQR method ----
    Q1 <- quantile(x, 0.25)
    Q3 <- quantile(x, 0.75)
    IQR_val <- Q3 - Q1
    lower_iqr <- Q1 - 1.5 * IQR_val
    upper_iqr <- Q3 + 1.5 * IQR_val
    iqr_outliers <- x[x < lower_iqr | x > upper_iqr]
    
    # ---- Percentile method ----
    p1  <- quantile(x, 0.01)
    p99 <- quantile(x, 0.99)
    pct_outliers <- x[x < p1 | x > p99]
    
    results[[col]] <- list(
      summary_stats = stats,
      zscore_outliers = z_outliers,
      z_outlier_pct = length(z_outliers) / length(x) * 100,
      iqr_outliers = iqr_outliers,
      iqr_outlier_pct = length(iqr_outliers) / length(x) * 100,
      percentile_outliers = pct_outliers,
      pct_outlier_pct = length(pct_outliers) / length(x) * 100
    )
  }
  
  return(results)
}

columns_to_check <- c(
  "FTHG","FTAG",      # goals
  "HTHG","HTAG",      # goals
  "HS","AS",          # shots
  "HST","AST",        # shots on target
  "HF","AF",          # fouls
  "HC","AC",          # corners
  "HY","AY",          # yellow cards
  "HR","AR"           # red cards
)

outliers <- outlier_analysis(Data_England, columns_to_check)



plot_outlier_heatmap <- function(outlier_list) {
  tibble(
    variable = names(outlier_list),
    zscore_pct   = sapply(outlier_list, function(x) x$z_outlier_pct),
    iqr_pct      = sapply(outlier_list, function(x) x$iqr_outlier_pct),
    percentile_pct = sapply(outlier_list, function(x) x$pct_outlier_pct)
  ) %>%
    pivot_longer(cols = -variable, names_to = "method", values_to = "pct") %>%
    ggplot(aes(x = method, y = variable, fill = pct)) +
    geom_tile() +
    scale_fill_gradient(low = "white", high = "red") +
    theme_minimal(base_size = 13) +
    labs(
      title = "Outlier Percentage by Method",
      x = "Method",
      y = "Variable",
      fill = "% Outliers"
    )
}

plot_outlier_heatmap(outliers)



```

For example, the outliers in home‑team goals per match (FTHG) and in red cards for both home (HR) and away teams (AR) are concentrated near the upper quantiles of their respective distributions.

```{r}
plot_density_outliers <- function(df, col) {
  x <- df[[col]]
  x <- x[!is.na(x)]
  
  p1  <- quantile(x, 0.05)
  p99 <- quantile(x, 0.95)
  
  tibble(value = x) %>%
    ggplot(aes(value)) +
    geom_bar(fill = "steelblue", alpha = 0.75) +
    geom_vline(xintercept = p1,  color = "red", linetype = "dashed") +
    geom_vline(xintercept = p99, color = "red", linetype = "dashed") +
    scale_x_continuous(breaks = seq(0, 9, by = 1))+
    theme_minimal(base_size = 13) +
    labs(
      title = paste("Distribution of", col),
      subtitle = "Red dashed lines = 5th & 95th percentiles",
      x = col,
      y = "Number of games"
    )
}

plot_density_outliers(Data_England, "FTHG")
plot_density_outliers(Data_England, "HR")
plot_density_outliers(Data_England, "AR")

```


::: {.callout-note collapse="true"}

## Note about variable names

The column names of our dataset are not very informative. We decided to include them here in case the description is useful.


- Div = League Division
- Date = Match Date (dd/mm/yy)
- Time = Time of match kick off
- HomeTeam = Home Team
- AwayTeam = Away Team
- FTHG and HG = Full Time Home Team Goals
- FTAG and AG = Full Time Away Team Goals
- FTR and Res = Full Time Result (H=Home Win, D=Draw, A=Away Win)
- HTHG = Half Time Home Team Goals
- HTAG = Half Time Away Team Goals
- HTR = Half Time Result (H=Home Win, D=Draw, A=Away Win)
- Referee = Match Referee
- HS = Home Team Shots
- AS = Away Team Shots
- HST = Home Team Shots on Target
- AST = Away Team Shots on Target
- HF = Home Team Fouls Committed
- AF = Away Team Fouls Committed
- HY = Home Team Yellow Cards
- AY = Away Team Yellow Cards
- HR = Home Team Red Cards
- AR = Away Team Red Cards

:::

